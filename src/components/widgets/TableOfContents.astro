---
import type { TocHeading } from "~/utils/getTableOfContents";

interface Props {
  headings: TocHeading[];
  title?: string;
}

const { headings, title = "Table of Contents" } = Astro.props;

// Don't render if there are no headings
if (!headings || headings.length === 0) {
  return null;
}
---

<nav class="toc font-sans" aria-label="Table of Contents">
  <button class="toc-toggle" aria-label="Toggle Table of Contents" aria-expanded="false">
    <svg class="toc-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
      <line x1="8" y1="6" x2="21" y2="6"></line>
      <line x1="8" y1="12" x2="21" y2="12"></line>
      <line x1="8" y1="18" x2="21" y2="18"></line>
      <line x1="3" y1="6" x2="3.01" y2="6"></line>
      <line x1="3" y1="12" x2="3.01" y2="12"></line>
      <line x1="3" y1="18" x2="3.01" y2="18"></line>
    </svg>
    <span class="toc-toggle-text">{title}</span>
  </button>
  <div class="toc-content">
    <div class="toc-header">
      <h2 class="toc-title">{title}</h2>
    </div>
    <ul class="toc-list">
      {
        headings.map((heading) => (
          <li class={`toc-item toc-depth-${heading.depth}`}>
            <a href={`#${heading.slug}`} class="toc-link">
              {heading.text}
            </a>
          </li>
        ))
      }
    </ul>
  </div>
</nav>

<style>
  .toc {
    position: fixed;
    bottom: 2rem;
    right: 2rem;
    z-index: 50;
    max-width: 320px;
  }

  .toc-toggle {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    background: #3b82f6; /* blue-500 */
    color: white;
    border: none;
    border-radius: 24px;
    padding: 0.75rem 1.25rem;
    cursor: pointer;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    transition: all 0.3s ease-in-out;
    font-weight: 600;
    font-size: 0.875rem;
  }

  .toc-toggle:hover {
    background: #2563eb; /* blue-600 */
    box-shadow: 0 6px 16px rgba(0, 0, 0, 0.2);
    transform: translateY(-2px);
  }

  :global(.dark) .toc-toggle {
    background: #60a5fa; /* blue-400 */
    color: #0f172a; /* slate-900 */
  }

  :global(.dark) .toc-toggle:hover {
    background: #93c5fd; /* blue-300 */
  }

  .toc-icon {
    width: 1.25rem;
    height: 1.25rem;
    flex-shrink: 0;
  }

  .toc-content {
    display: none;
    background: #ffffff;
    border: 1px solid #e2e8f0; /* slate-200 */
    border-radius: 12px;
    box-shadow: 0 10px 30px rgba(0, 0, 0, 0.15);
    padding: 1.5rem;
    margin-bottom: 1rem;
    max-height: calc(100vh - 12rem);
    overflow-y: auto;
  }

  :global(.dark) .toc-content {
    background: #1e293b; /* slate-800 */
    border-color: #334155; /* slate-700 */
    box-shadow: 0 10px 30px rgba(0, 0, 0, 0.4);
  }

  .toc.expanded .toc-content {
    display: block;
  }

  .toc.expanded .toc-toggle {
    border-radius: 12px;
  }

  .toc-header {
    margin-bottom: 1rem;
    padding-bottom: 0.75rem;
    border-bottom: 2px solid #e2e8f0; /* slate-200 */
  }

  :global(.dark) .toc-header {
    border-bottom-color: #334155; /* slate-700 */
  }

  .toc-title {
    font-size: 1.125rem;
    font-weight: 700;
    color: #0f172a; /* slate-900 */
    margin: 0;
  }

  :global(.dark) .toc-title {
    color: #f1f5f9; /* slate-100 */
  }

  .toc-list {
    list-style: none;
    padding: 0;
    margin: 0;
  }

  .toc-item {
    margin: 0;
  }

  .toc-link {
    display: block;
    padding: 0.5rem 0;
    color: #475569; /* slate-600 */
    text-decoration: none;
    transition: all 0.2s ease-in-out;
    border-left: 2px solid transparent;
    padding-left: 0.75rem;
    font-size: 0.875rem;
  }

  .toc-link:hover {
    color: #3b82f6; /* blue-500 */
    border-left-color: #3b82f6; /* blue-500 */
    background: #f1f5f9; /* slate-100 */
  }

  :global(.dark) .toc-link {
    color: #e2e8f0; /* slate-200 */
  }

  :global(.dark) .toc-link:hover {
    color: #60a5fa; /* blue-400 */
    border-left-color: #60a5fa; /* blue-400 */
    background: #0f172a; /* slate-900 */
  }

  /* Indentation for different heading depths */
  .toc-depth-2 .toc-link {
    padding-left: 0.75rem;
    font-weight: 600;
  }

  .toc-depth-3 .toc-link {
    padding-left: 1.5rem;
    font-size: 0.8125rem;
  }

  .toc-depth-4 .toc-link {
    padding-left: 2.25rem;
    font-size: 0.75rem;
  }

  .toc-depth-5 .toc-link {
    padding-left: 3rem;
    font-size: 0.75rem;
  }

  .toc-depth-6 .toc-link {
    padding-left: 3.75rem;
    font-size: 0.6875rem;
  }

  /* Active link highlighting */
  .toc-link:focus {
    outline: 2px solid #3b82f6; /* blue-500 */
    outline-offset: 2px;
    border-radius: 2px;
  }

  :global(.dark) .toc-link:focus {
    outline-color: #60a5fa; /* blue-400 */
  }

  /* Custom scrollbar for ToC */
  .toc-content::-webkit-scrollbar {
    width: 4px;
  }

  .toc-content::-webkit-scrollbar-track {
    background: transparent;
  }

  .toc-content::-webkit-scrollbar-thumb {
    background: #cbd5e1; /* slate-300 */
    border-radius: 4px;
  }

  @media (prefers-color-scheme: dark) {
    .toc-content::-webkit-scrollbar-thumb {
      background: #475569; /* slate-600 */
    }
  }

  /* Mobile adjustments */
  @media (max-width: 640px) {
    .toc {
      bottom: 1rem;
      right: 1rem;
      max-width: calc(100vw - 2rem);
    }

    .toc-toggle-text {
      display: none;
    }

    .toc-toggle {
      padding: 0.75rem;
      border-radius: 50%;
    }

    .toc.expanded .toc-toggle {
      border-radius: 50%;
    }
  }
</style>

<script is:inline>
  (function() {
    function initTableOfContents() {
      const toc = document.querySelector('.toc');
      const tocToggle = document.querySelector('.toc-toggle');
      const tocLinks = document.querySelectorAll('.toc-link');

      if (!tocLinks.length || !tocToggle || !toc) return;

      // Prevent duplicate listeners by cloning and replacing
      const newToggle = tocToggle.cloneNode(true);
      tocToggle.parentNode.replaceChild(newToggle, tocToggle);

      // Toggle ToC visibility
      newToggle.addEventListener('click', function(e) {
        e.preventDefault();
        e.stopPropagation();
        const isExpanded = toc.classList.toggle('expanded');
        newToggle.setAttribute('aria-expanded', isExpanded.toString());
      });

      // Close ToC when clicking a link
      tocLinks.forEach(function(link) {
        const newLink = link.cloneNode(true);
        link.parentNode.replaceChild(newLink, link);

        newLink.addEventListener('click', function(e) {
          e.preventDefault();
          const href = newLink.getAttribute('href');
          if (href && href.startsWith('#')) {
            const target = document.querySelector(href);
            if (target) {
              target.scrollIntoView({ behavior: 'smooth', block: 'start' });
              history.pushState(null, '', href);
              toc.classList.remove('expanded');
              newToggle.setAttribute('aria-expanded', 'false');
            }
          }
        });
      });

      // Close ToC when clicking outside (use capture to ensure we catch it)
      document.addEventListener('click', function(e) {
        if (toc && !toc.contains(e.target)) {
          toc.classList.remove('expanded');
          const btn = toc.querySelector('.toc-toggle');
          if (btn) btn.setAttribute('aria-expanded', 'false');
        }
      }, { capture: true, once: false });

      // Intersection observer for active link highlighting
      const freshLinks = document.querySelectorAll('.toc-link');
      const observer = new IntersectionObserver(
        function(entries) {
          entries.forEach(function(entry) {
            const id = entry.target.getAttribute('id');
            const tocLink = document.querySelector('.toc-link[href="#' + id + '"]');

            if (entry.isIntersecting && tocLink) {
              freshLinks.forEach(function(link) {
                link.classList.remove('active');
              });
              tocLink.classList.add('active');
            }
          });
        },
        { rootMargin: '-80px 0px -80% 0px' }
      );

      freshLinks.forEach(function(link) {
        const href = link.getAttribute('href');
        if (href && href.startsWith('#')) {
          const id = href.substring(1);
          const heading = document.getElementById(id);
          if (heading) {
            observer.observe(heading);
          }
        }
      });
    }

    // Initialize on page load
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', initTableOfContents);
    } else {
      initTableOfContents();
    }

    // Re-initialize on Astro page transitions
    document.addEventListener('astro:page-load', initTableOfContents);
  })();
</script>

<style is:global>
  .toc-link.active {
    color: #3b82f6 !important; /* blue-500 */
    border-left-color: #3b82f6 !important; /* blue-500 */
    font-weight: 600;
  }

  @media (prefers-color-scheme: dark) {
    .toc-link.active {
      color: #60a5fa !important; /* blue-400 */
      border-left-color: #60a5fa !important; /* blue-400 */
    }
  }
</style>
