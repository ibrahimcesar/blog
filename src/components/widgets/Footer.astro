---
import certifications from "~/data/certifications.json";
import { getCollection } from 'astro:content';

// Calculate stats across all blog posts at build time
const posts = await getCollection('posts');
const allBlogText = posts.map(p => p.body).join(' ');
const totalWords = allBlogText.split(/\s+/).filter(word => word.length > 0).length;
const totalPosts = posts.length;

// Calculate Shannon entropy of all blog content
function calculateEntropy(text: string): number {
  if (!text || text.length === 0) return 0;
  const freq: Record<string, number> = {};
  for (const char of text) {
    freq[char] = (freq[char] || 0) + 1;
  }
  const len = text.length;
  let entropy = 0;
  for (const char in freq) {
    const p = freq[char] / len;
    entropy -= p * Math.log2(p);
  }
  return entropy;
}
const blogEntropy = calculateEntropy(allBlogText);
---

<footer>
  <div class="max-w-6xl mx-auto px-4 sm:px-6">
    <div
      class="grid grid-cols-12 gap-4 gap-y-8 sm:gap-8 py-8 md:py-12 border-t border-gray-200 dark:border-slate-800"
    >
      <div class="col-span-12 lg:col-span-3">
        <div class="mb-2">
          <a class="inline-block font-bold text-xl" href="/">Ibrahim Cesar</a>
        </div>
        <div class="text-sm text-gray-600">
          <a
            class="text-gray-600 dark:text-gray-400 hover:underline transition duration-150 ease-in-out"
            rel="noopener noreferrer"
            title="Code for this blog & content!"
            target="_blank"
            href="https://github.com/ibrahimcesar/blog"
            ><span class="external">Source Code</span>
          </a>  Â·
          <a
            class="text-gray-600 dark:text-gray-400 hover:underline transition duration-150 ease-in-out"
            title="Terms of Use"
            href="/terms-and-privacy"
            >Terms and Privacy Policy
          </a>
        </div>
      </div>
    </div>

    <div class="grid grid-cols-12 gap-4 gap-y-8">

      <div class="col-span-6 md:col-span-2 lg:col-span-2">

        <div class="text-gray-800 dark:text-gray-300 font-medium mb-2">
          Find me
        </div>
        <ul class="text-sm">
            <a
              class="text-gray-600 dark:text-gray-400 transition duration-150 ease-in-out"
              rel="noopener noreferrer"
              target="_blank"
              title="My repositories & contributions"
              href="https://github.com/ibrahimcesar"
              ><span class="external">GitHub</span>
            </a> Â·
            <a
              class="text-gray-600 dark:text-gray-400 transition duration-150 ease-in-out"
              rel="noopener noreferrer"
              target="_blank"
              title="My professional experience"
              href="https://www.linkedin.com/in/ibrahimcesar/?locale=en_US"
              ><span class="external">LinkedIn</span>
            </a> Â·
            <a
              class="text-gray-600 dark:text-gray-400 transition duration-150 ease-in-out"
              rel="noopener noreferrer"
              target="_blank"
              title="View my Badges on Credly"
              href="https://www.credly.com/users/ibrahimcesar"
              ><span class="external">Credly</span>
            </a>
        </ul>
      </div>

      <div class="col-span-6 md:col-span-2 lg:col-span-2">
        <div class="text-gray-800 dark:text-gray-300 font-medium mb-2">
          Pages
        </div>
        <ul class="text-sm">
            <a
              class="text-gray-600  dark:text-gray-400 transition duration-150 ease-in-out"
              href="/talks"
              >Talks
            </a> Â·
            <a
              class="text-gray-600  dark:text-gray-400 transition duration-150 ease-in-out"
              href="/whoiam"
              >About/Sobre
            </a>
        </ul>
      </div>

      <div class="col-span-12 md:col-span-8 lg:col-span-8">
        <div class="mb-3">
          <div class="text-gray-800 dark:text-gray-300 font-medium mb-3">
            AWS Certifications
          </div>

          <!-- Visible Certifications -->
          <div class="mb-3">
            {certifications.visible.map((cert) => (
              <div class="inline-block">
                <a
                  href={cert.href}
                  target="_blank"
                  title={cert.title}
                  rel="noopener noreferrer"
                >
                  <img
                    src={cert.src}
                    alt={cert.title}
                    width="100px"
                  >
                </a>
              </div>
            ))}
          </div>

          <!-- Additional Badges (Expandable) -->
          <div id="additional-badges" class="hidden">
            {certifications.additional.map((cert) => (
              <div class="inline-block">
                <a
                  href={cert.href}
                  target="_blank"
                  title={cert.title}
                  rel="noopener noreferrer"
                >
                  <img
                    src={cert.src}
                    alt={cert.title}
                    width="100px"
                  >
                </a>
              </div>
            ))}
          </div>

          <!-- Show More/Less Button and Credly Link -->
          <div class="mt-2">
            <button
              id="toggle-badges"
              class="text-sm text-gray-600 dark:text-gray-400 hover:text-gray-800 dark:hover:text-gray-200 underline transition duration-150 ease-in-out"
              aria-expanded="false"
              aria-controls="additional-badges"
              data-original-text={`Show ${certifications.additional.length} more badges`}
            >
              Show {certifications.additional.length} more badges
            </button>
            <span class="text-sm text-gray-600 dark:text-gray-400 mx-2">Â·</span>
            <a
              href="https://www.credly.com/users/ibrahimcesar"
              target="_blank"
              rel="noopener noreferrer"
              class="text-sm text-gray-600 dark:text-gray-400 hover:text-gray-800 dark:hover:text-gray-200 underline transition duration-150 ease-in-out"
              title="View all my badges on Credly"
            >
              <span class="external">View all 50+ badges on Credly</span>
            </a>
          </div>
        </div>
      </div>
    </div>


    <div class="md:flex md:items-center md:justify-between py-8">
      <div class="text-sm text-gray-700 mr-4 dark:text-slate-400">
        &copy; 2020 â€” {new Date().getFullYear()} <em>All rights reserved</em>. Made with
      <span role="img" aria-label="puzzle piece">&nbsp;ðŸ§©&nbsp;</span>
      in SÃ£o Paulo, Brazil. Built with ðŸš€ <a rel="noopener noreferrer" href="https://astro.build" target="_blank" class="underline"><span class="external">Astro v5.15.8</span></a>, hosted on <a rel="noopener noreferrer" href="https://aws.amazon.com/amplify/" target="_blank" class="underline"><span class="external">AWS Amplify</span></a>. This blog represents my own viewpoints and not those of my employer, Amazon Web Services (AWS).
      <details class="mt-2 text-xs">
        <summary class="cursor-pointer font-mono text-gray-500 dark:text-gray-500 hover:text-gray-700 dark:hover:text-gray-300">
          Stats for nerds â–¾
        </summary>
        <div class="mt-2 font-mono text-gray-500 dark:text-gray-500 space-y-0.5 pl-2 border-l-2 border-gray-300 dark:border-gray-600">
          <div>FCP: <span id="fcp-time">...</span></div>
          <div>LCP: <span id="lcp-time">...</span></div>
          <div>TTI: <span id="tti-time">...</span></div>
          <div>Page load: <span id="page-load-time">...</span></div>
          <div>Page size: <span id="page-size">...</span></div>
          <div>DOM nodes: <span id="dom-nodes">...</span></div>
          <div>Carbon: ~<span id="carbon-estimate">...</span>g COâ‚‚</div>
          <div>Blog: {totalWords.toLocaleString()} words in {totalPosts} posts</div>
          <div>Entropy: {blogEntropy.toFixed(3)} bits/char</div>
          <div>Built: {new Date().toISOString().substring(0, 10)}</div>
          <div>Unix: <span id="unix-timestamp">...</span></div>
        </div>
      </details>
      </div>
      <div class="mt-4 md:mt-0">
        <iframe src="https://github.com/sponsors/ibrahimcesar/button" title="Sponsor ibrahimcesar" height="32" width="114" style="border: 0; border-radius: 6px;"></iframe>
      </div>
    </div>
  </div>
</footer>

<script>
  // Toggle additional badges
  const toggleButton = document.getElementById('toggle-badges');
  const additionalBadges = document.getElementById('additional-badges');

  if (toggleButton && additionalBadges) {
    toggleButton.addEventListener('click', () => {
      const isHidden = additionalBadges.classList.contains('hidden');

      if (isHidden) {
        additionalBadges.classList.remove('hidden');
        toggleButton.setAttribute('aria-expanded', 'true');
        toggleButton.textContent = 'Show fewer badges';
      } else {
        additionalBadges.classList.add('hidden');
        toggleButton.setAttribute('aria-expanded', 'false');
        toggleButton.textContent = toggleButton.dataset.originalText;
      }
    });
  }

  // Helper to format time
  function formatTime(ms: number): string {
    return ms >= 1000 ? `${(ms / 1000).toFixed(2)}s` : `${Math.round(ms)}ms`;
  }

  // Nerd stats using Performance API
  function displayNerdStats() {
    const fcpEl = document.getElementById('fcp-time');
    const lcpEl = document.getElementById('lcp-time');
    const ttiEl = document.getElementById('tti-time');
    const loadTimeEl = document.getElementById('page-load-time');
    const pageSizeEl = document.getElementById('page-size');
    const domNodesEl = document.getElementById('dom-nodes');
    const carbonEl = document.getElementById('carbon-estimate');
    const unixEl = document.getElementById('unix-timestamp');

    const navEntry = performance.getEntriesByType('navigation')[0] as PerformanceNavigationTiming;

    // First Contentful Paint (FCP)
    if (fcpEl) {
      const fcpEntry = performance.getEntriesByName('first-contentful-paint')[0];
      if (fcpEntry) {
        fcpEl.textContent = formatTime(fcpEntry.startTime);
      }
    }

    // Largest Contentful Paint (LCP) - uses PerformanceObserver
    if (lcpEl && 'PerformanceObserver' in window) {
      try {
        const lcpEntries = performance.getEntriesByType('largest-contentful-paint');
        if (lcpEntries.length > 0) {
          const lastLcp = lcpEntries[lcpEntries.length - 1] as PerformanceEntry;
          lcpEl.textContent = formatTime(lastLcp.startTime);
        } else {
          // Set up observer for LCP
          new PerformanceObserver((list) => {
            const entries = list.getEntries();
            const lastEntry = entries[entries.length - 1];
            if (lastEntry && lcpEl) {
              lcpEl.textContent = formatTime(lastEntry.startTime);
            }
          }).observe({ type: 'largest-contentful-paint', buffered: true });
        }
      } catch (e) {
        lcpEl.textContent = 'N/A';
      }
    }

    // Time to Interactive (TTI) - approximated using domInteractive
    if (ttiEl && navEntry) {
      const tti = navEntry.domInteractive - navEntry.fetchStart;
      if (tti > 0) {
        ttiEl.textContent = formatTime(tti);
      }
    }

    // Page load time
    if (loadTimeEl && navEntry) {
      const loadTime = navEntry.loadEventEnd - navEntry.fetchStart;
      if (loadTime > 0) {
        loadTimeEl.textContent = formatTime(loadTime);
      }
    }

    // Page size (transferred bytes)
    if (pageSizeEl) {
      const resources = performance.getEntriesByType('resource') as PerformanceResourceTiming[];
      let totalBytes = navEntry?.transferSize || 0;
      resources.forEach(r => { totalBytes += r.transferSize || 0; });

      if (totalBytes > 0) {
        pageSizeEl.textContent = totalBytes > 1024 * 1024
          ? `${(totalBytes / (1024 * 1024)).toFixed(2)} MB`
          : totalBytes > 1024
            ? `${(totalBytes / 1024).toFixed(1)} KB`
            : `${totalBytes} B`;

        // Carbon estimate: ~0.2g CO2 per MB (Website Carbon methodology)
        if (carbonEl) {
          const mbTransferred = totalBytes / (1024 * 1024);
          const carbonGrams = (mbTransferred * 0.2).toFixed(3);
          carbonEl.textContent = carbonGrams;
        }
      }
    }

    // DOM nodes count
    if (domNodesEl) {
      domNodesEl.textContent = document.getElementsByTagName('*').length.toLocaleString();
    }

    // Unix timestamp
    if (unixEl) {
      unixEl.textContent = Math.floor(Date.now() / 1000).toString();
    }
  }

  // Run after page fully loads
  if (document.readyState === 'complete') {
    setTimeout(displayNerdStats, 0);
  } else {
    window.addEventListener('load', () => setTimeout(displayNerdStats, 0));
  }

  // Re-run on Astro page transitions
  document.addEventListener('astro:page-load', () => setTimeout(displayNerdStats, 0));
</script>
