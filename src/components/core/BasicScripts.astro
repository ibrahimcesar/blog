---
const {} = Astro.props;
---

<script type="module">
  import mermaid from 'https://cdn.jsdelivr.net/npm/mermaid@11/dist/mermaid.esm.min.mjs';

  function initMermaid() {
    const isDark = document.documentElement.classList.contains('dark');
    mermaid.initialize({
      startOnLoad: false,
      theme: isDark ? 'dark' : 'default'
    });

    // Only render elements that haven't been rendered yet
    // Check for: no SVG inside, and text content starts with a valid mermaid keyword
    const validDiagramTypes = ['flowchart', 'graph', 'sequenceDiagram', 'classDiagram', 'stateDiagram', 'erDiagram', 'gantt', 'pie', 'journey', 'gitGraph', 'timeline', 'mindmap', 'quadrantChart', 'xychart', 'sankey', 'block', '%%'];

    const unrenderedDiagrams = Array.from(document.querySelectorAll('pre.mermaid')).filter(el => {
      // Skip if already has SVG
      if (el.querySelector('svg')) return false;

      // Check if text content looks like a mermaid diagram
      const text = el.textContent?.trim() || '';
      return validDiagramTypes.some(type => text.startsWith(type) || text.toLowerCase().startsWith(type.toLowerCase()));
    });

    if (unrenderedDiagrams.length > 0) {
      mermaid.run({ nodes: unrenderedDiagrams }).then(() => {
        addExpandButtons();
      }).catch(err => {
        console.warn('Mermaid rendering error:', err);
        addExpandButtons();
      });
    } else {
      // Still add expand buttons for already-rendered diagrams
      addExpandButtons();
    }
  }

  function addExpandButtons() {
    document.querySelectorAll('pre.mermaid').forEach((pre) => {
      // Skip if already has expand button
      if (pre.parentElement?.classList.contains('mermaid-wrapper')) return;

      // Wrap the pre element
      const wrapper = document.createElement('div');
      wrapper.className = 'mermaid-wrapper';
      pre.parentNode.insertBefore(wrapper, pre);
      wrapper.appendChild(pre);

      // Add expand button
      const btn = document.createElement('button');
      btn.className = 'mermaid-expand-btn';
      btn.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 3h6v6M9 21H3v-6M21 3l-7 7M3 21l7-7"/></svg>`;
      btn.title = 'Expand diagram';
      btn.onclick = () => openModal(pre);
      wrapper.appendChild(btn);
    });
  }

  function openModal(pre) {
    const svg = pre.querySelector('svg');
    if (!svg) return;

    const overlay = document.createElement('div');
    overlay.className = 'mermaid-modal-overlay';
    overlay.innerHTML = `
      <div class="mermaid-modal">
        <button class="mermaid-modal-close" title="Close">&times;</button>
        <div class="mermaid-modal-content">${svg.outerHTML}</div>
      </div>
    `;

    overlay.querySelector('.mermaid-modal-close').onclick = () => overlay.remove();
    overlay.onclick = (e) => { if (e.target === overlay) overlay.remove(); };
    document.addEventListener('keydown', function escClose(e) {
      if (e.key === 'Escape') { overlay.remove(); document.removeEventListener('keydown', escClose); }
    });

    document.body.appendChild(overlay);
  }

  // Run on initial load
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initMermaid);
  } else {
    initMermaid();
  }

  // Re-run after View Transitions
  document.addEventListener('astro:page-load', initMermaid);
</script>

<script is:inline>
  // Function to apply dark mode
  function applyDarkMode() {
    if (
      localStorage.theme === "dark" ||
      (!("theme" in localStorage) &&
        window.matchMedia("(prefers-color-scheme: dark)").matches)
    ) {
      document.documentElement.classList.add("dark");
    } else {
      document.documentElement.classList.remove("dark");
    }
  }

  // Apply on initial load
  applyDarkMode();

  // Reapply after View Transitions - multiple event listeners for reliability
  document.addEventListener('astro:after-swap', () => {
    applyDarkMode();
    // Force a repaint to ensure styles apply immediately
    document.body.offsetHeight;
  });

  document.addEventListener('astro:page-load', applyDarkMode);

  function attachEvent(selector, event, fn) {
    const matches = document.querySelectorAll(selector);
    if (matches && matches.length) {
      matches.forEach((elem) => {
        elem.addEventListener(
          event,
          function () {
            fn(elem);
          },
          false
        );
      });
    }
  }

  window.onload = function () {
    attachEvent("[data-aw-toggle-menu]", "click", function (elem) {
      elem.classList.toggle("expanded");
      document.getElementById("menu")?.classList.toggle("hidden");
    });

    attachEvent("[data-aw-toggle-color-scheme]", "click", function (elem) {
      document.documentElement.classList.toggle("dark");
      localStorage.theme = document.documentElement.classList.contains("dark")
        ? "dark"
        : "light";
    });
  };
  window.onpageshow = function () {
    const elem = document.querySelector("[data-aw-toggle-menu]");
    if (elem) {
      elem.classList.remove("expanded");
    }
    document.getElementById("menu")?.classList.add("hidden");
  };
</script>
