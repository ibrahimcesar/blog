---
/**
 * YouTube Component
 *
 * A lightweight, performant YouTube embed using react-lite-youtube-embed
 * Loads significantly faster than standard YouTube iframes by deferring the player
 * until user interaction
 *
 * @param {string} videoId - YouTube video ID (required)
 * @param {string} title - Video title for accessibility (optional, recommended)
 * @param {string} aspectHeight - Aspect ratio height (default: 9)
 * @param {string} playlistCoverId - Cover video ID for playlists (optional)
 * @param {string} params - Additional YouTube URL parameters (optional)
 * @param {string} poster - Poster quality: "default" | "hqdefault" | "mqdefault" | "sddefault" | "maxresdefault" (default: "hqdefault")
 * @param {boolean} noCookie - Use youtube-nocookie.com domain (default: true)
 * @param {string} announce - Custom screen reader announcement (optional)
 *
 * @example
 * ```astro
 * <YouTube videoId="dQw4w9WgXcQ" title="Rick Astley - Never Gonna Give You Up" />
 * ```
 *
 * @example
 * ```astro
 * <YouTube
 *   videoId="6avJHaC3C2U"
 *   title="The Art of Code by Dylan Beattie"
 *   poster="maxresdefault"
 * />
 * ```
 */

const {
  videoId,
  title = "YouTube video player",
  aspectHeight = 9,
  playlistCoverId,
  params,
  poster = "hqdefault",
  noCookie = true,
  announce = "Watch"
} = Astro.props;

if (!videoId) {
  throw new Error('YouTube component requires a videoId prop');
}
---

<div class="youtube-wrapper">
  <lite-youtube
    videoid={videoId}
    videotitle={title}
    aspectHeight={aspectHeight}
    playlistCoverId={playlistCoverId}
    params={params}
    poster={poster}
    nocookie={noCookie}
    announce={announce}
  ></lite-youtube>
</div>

<script>
  // Import the lite-youtube custom element
  import 'react-lite-youtube-embed/dist/LiteYouTubeEmbed.css';

  // Register the custom element
  if (!customElements.get('lite-youtube')) {
    class LiteYouTube extends HTMLElement {
      connectedCallback() {
        // Get attributes
        const videoId = this.getAttribute('videoid');
        const videoTitle = this.getAttribute('videotitle') || 'YouTube video player';
        const poster = this.getAttribute('poster') || 'hqdefault';
        const noCookie = this.getAttribute('nocookie') === 'true';
        const params = this.getAttribute('params') || '';

        // Build the thumbnail URL
        const posterUrl = `https://i.ytimg.com/vi/${videoId}/${poster}.jpg`;

        // Build the YouTube domain
        const ytDomain = noCookie ? 'youtube-nocookie.com' : 'youtube.com';

        // Create the structure
        this.innerHTML = `
          <div class="yt-lite">
            <img
              class="yt-lite-thumbnail"
              src="${posterUrl}"
              alt="${videoTitle}"
              loading="lazy"
            />
            <button
              type="button"
              class="lty-playbtn"
              aria-label="Play: ${videoTitle}"
            >
              <span class="lyt-visually-hidden">Play: ${videoTitle}</span>
            </button>
          </div>
        `;

        // Add click handler
        const playBtn = this.querySelector('.lty-playbtn');
        playBtn?.addEventListener('click', () => this.addIframe());
      }

      addIframe() {
        const videoId = this.getAttribute('videoid');
        const noCookie = this.getAttribute('nocookie') === 'true';
        const params = this.getAttribute('params') || '';
        const ytDomain = noCookie ? 'youtube-nocookie.com' : 'youtube.com';

        const iframe = document.createElement('iframe');
        iframe.width = '560';
        iframe.height = '315';
        iframe.title = this.getAttribute('videotitle') || 'YouTube video player';
        iframe.allow = 'accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture';
        iframe.allowFullscreen = true;
        iframe.src = `https://www.${ytDomain}/embed/${videoId}?autoplay=1${params ? '&' + params : ''}`;

        const container = this.querySelector('.yt-lite');
        if (container) {
          // Keep the container but replace its contents with iframe
          container.innerHTML = '';
          container.appendChild(iframe);
          container.classList.add('lyt-activated');
        }
      }
    }

    customElements.define('lite-youtube', LiteYouTube);
  }
</script>

<style>
  .youtube-wrapper {
    margin: 2rem 0;
    border-radius: 0.5rem;
    overflow: hidden;
    box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
  }

  .youtube-wrapper :global(.yt-lite) {
    background-color: #000;
    position: relative;
    display: block;
    contain: content;
    background-position: center center;
    background-size: cover;
    cursor: pointer;
    aspect-ratio: 16 / 9;
  }

  .youtube-wrapper :global(.yt-lite::before) {
    content: '';
    display: block;
    position: absolute;
    top: 0;
    background-image: url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAADGCAYAAAAT+OqFAAAAdklEQVQoz42QQQ7AIAgEF/T/D+kbq/RWAlnQyyazA4aoAB4FsBSA/bFjuF1EOL7VbrIrBuusmrt4ZZORfb6ehbWdnRHEIiITaEUKa5EJqUakRSaEYBJSCY2dEstQY7AuxahwXFrvZmWl2rh4JZ07z9dLtesfNj5q0FU3A5ObbwAAAABJRU5ErkJggg==);
    background-position: top;
    background-repeat: repeat-x;
    height: 60px;
    padding-bottom: 50px;
    width: 100%;
    transition: all 0.2s cubic-bezier(0, 0, 0.2, 1);
  }

  .youtube-wrapper :global(.yt-lite-thumbnail) {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    object-fit: cover;
  }

  .youtube-wrapper :global(.lty-playbtn) {
    width: 68px;
    height: 48px;
    position: absolute;
    cursor: pointer;
    transform: translate3d(-50%, -50%, 0);
    top: 50%;
    left: 50%;
    z-index: 1;
    background-color: transparent;
    background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 68 48"><path d="M66.52 7.74c-.78-2.93-2.49-5.41-5.42-6.19C55.79.13 34 0 34 0S12.21.13 6.9 1.55c-2.93.78-4.63 3.26-5.42 6.19C.06 13.05 0 24 0 24s.06 10.95 1.48 16.26c.78 2.93 2.49 5.41 5.42 6.19C12.21 47.87 34 48 34 48s21.79-.13 27.1-1.55c2.93-.78 4.64-3.26 5.42-6.19C67.94 34.95 68 24 68 24s-.06-10.95-1.48-16.26z" fill="red"/><path d="M45 24 27 14v20" fill="white"/></svg>');
    filter: grayscale(100%);
    transition: filter 0.1s cubic-bezier(0, 0, 0.2, 1);
    border: none;
  }

  .youtube-wrapper :global(.lty-playbtn:hover),
  .youtube-wrapper :global(.lty-playbtn:focus) {
    filter: none;
  }

  .youtube-wrapper :global(.lyt-visually-hidden) {
    clip: rect(0 0 0 0);
    clip-path: inset(50%);
    height: 1px;
    overflow: hidden;
    position: absolute;
    white-space: nowrap;
    width: 1px;
  }

  .youtube-wrapper :global(iframe) {
    width: 100%;
    height: 100%;
    position: absolute;
    top: 0;
    left: 0;
    border: 0;
  }

  @media (prefers-color-scheme: dark) {
    .youtube-wrapper {
      box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.3), 0 2px 4px -1px rgba(0, 0, 0, 0.2);
    }
  }
</style>
