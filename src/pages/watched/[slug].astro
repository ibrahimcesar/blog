---
import { getCollection, render } from 'astro:content';
import Layout from '~/layouts/PageLayout.astro';
import Tags from '~/components/widgets/Tags.astro';

export async function getStaticPaths() {
  const watched = await getCollection('watched');
  return watched.map((item) => ({
    params: { slug: item.slug },
    props: { item },
  }));
}

const { item } = Astro.props;
const { title, videoId, channel, duration, pubDate, tags, description } = item.data;
const { Content } = await render(item);

// Format date
const formattedDate = new Date(pubDate).toLocaleDateString('en-US', {
  year: 'numeric',
  month: 'long',
  day: 'numeric',
});
---

<Layout meta={{ title: `${title} | What I Watched`, description: description || title }}>
  <main>
    <article class="px-4 sm:px-6 py-8 sm:py-12 mx-auto max-w-4xl">
      <!-- Header -->
      <header class="mb-8">
        <div class="flex items-center gap-2 text-sm text-slate-500 dark:text-slate-400 mb-4">
          <a href="/watched" class="hover:text-indigo-600 dark:hover:text-indigo-400">
            ‚Üê Back to What I Watched
          </a>
        </div>

        <h1 class="text-3xl md:text-4xl font-bold text-slate-900 dark:text-white mb-4">
          {title}
        </h1>

        <div class="flex flex-wrap items-center gap-4 text-sm text-slate-600 dark:text-slate-400">
          {channel && (
            <span class="flex items-center gap-1">
              <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 24 24">
                <path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/>
              </svg>
              {channel}
            </span>
          )}
          {duration && (
            <span class="flex items-center gap-1">
              <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 24 24">
                <path d="M11.99 2C6.47 2 2 6.48 2 12s4.47 10 9.99 10C17.52 22 22 17.52 22 12S17.52 2 11.99 2zM12 20c-4.42 0-8-3.58-8-8s3.58-8 8-8 8 3.58 8 8-3.58 8-8 8zm.5-13H11v6l5.25 3.15.75-1.23-4.5-2.67z"/>
              </svg>
              {duration}
            </span>
          )}
          <time datetime={pubDate.toISOString()}>
            {formattedDate}
          </time>
        </div>

        {tags && tags.length > 0 && (
          <div class="mt-4">
            <Tags tags={tags} size="sm" />
          </div>
        )}
      </header>

      <!-- Video embed and content -->
      <div class="prose prose-lg dark:prose-invert max-w-none">
        <Content />
      </div>

      <!-- Watch on YouTube link -->
      <div class="mt-8 pt-6 border-t border-slate-200 dark:border-slate-700">
        <a
          href={`https://www.youtube.com/watch?v=${videoId}`}
          target="_blank"
          rel="noopener noreferrer"
          class="inline-flex items-center gap-2 text-red-600 hover:text-red-700 dark:text-red-500 dark:hover:text-red-400 font-medium"
        >
          <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24">
            <path d="M19.615 3.184c-3.604-.246-11.631-.245-15.23 0-3.897.266-4.356 2.62-4.385 8.816.029 6.185.484 8.549 4.385 8.816 3.6.245 11.626.246 15.23 0 3.897-.266 4.356-2.62 4.385-8.816-.029-6.185-.484-8.549-4.385-8.816zm-10.615 12.816v-8l8 3.993-8 4.007z"/>
          </svg>
          Watch on YouTube
        </a>
      </div>
    </article>
  </main>
</Layout>
