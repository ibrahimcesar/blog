---
import Layout from "~/layouts/PageLayout.astro";
import { SITE } from "~/config.mjs";
import { getTagCounts } from "~/utils/getPostsCollection";

const tagCounts = await getTagCounts();
const sortedTags = Object.entries(tagCounts).sort((a, b) => b[1] - a[1]);

const title = `Tags — ${SITE.name}`;
const description = "Browse posts by topic. Explore cloud computing, AWS, serverless, and software development content.";
const canonical = new URL("tags", Astro.site);

// Color palette for tags - same as Tags.astro
const colorPalette = [
  { bg: "bg-rose-600", hover: "hover:bg-rose-700" },
  { bg: "bg-pink-600", hover: "hover:bg-pink-700" },
  { bg: "bg-fuchsia-600", hover: "hover:bg-fuchsia-700" },
  { bg: "bg-purple-600", hover: "hover:bg-purple-700" },
  { bg: "bg-violet-600", hover: "hover:bg-violet-700" },
  { bg: "bg-indigo-600", hover: "hover:bg-indigo-700" },
  { bg: "bg-blue-600", hover: "hover:bg-blue-700" },
  { bg: "bg-cyan-700", hover: "hover:bg-cyan-800" },
  { bg: "bg-teal-600", hover: "hover:bg-teal-700" },
  { bg: "bg-emerald-600", hover: "hover:bg-emerald-700" },
  { bg: "bg-green-600", hover: "hover:bg-green-700" },
  { bg: "bg-lime-600", hover: "hover:bg-lime-700" },
  { bg: "bg-amber-600", hover: "hover:bg-amber-700" },
  { bg: "bg-orange-600", hover: "hover:bg-orange-700" },
  { bg: "bg-red-600", hover: "hover:bg-red-700" },
];

// Generate consistent color index based on tag string
const getColorIndex = (tag: string) => {
  let hash = 0;
  for (let i = 0; i < tag.length; i++) {
    hash = ((hash << 5) - hash) + tag.charCodeAt(i);
    hash = hash & hash;
  }
  return Math.abs(hash) % colorPalette.length;
};
---

<Layout meta={{ title, description, canonical }}>
  <main>
    <section class="px-4 sm:px-6 py-12 sm:py-16 lg:py-20 mx-auto max-w-4xl">
      <header class="mb-12">
        <h1
          class="text-center text-5xl md:text-6xl font-bold leading-tighter tracking-tighter mb-4 text-slate-900 dark:text-white"
        >
          Browse by Tag
        </h1>
        <p class="text-center text-xl text-slate-700 dark:text-slate-300 max-w-2xl mx-auto">
          Explore {sortedTags.length} topics across {Object.values(tagCounts).reduce((a, b) => a + b, 0)} posts
        </p>
      </header>

      <div class="flex flex-wrap gap-3 justify-center">
        {
          sortedTags.map(([tag, count]) => {
            // Calculate size based on count (min 0.875rem, max 1.5rem)
            const minSize = 0.875;
            const maxSize = 1.5;
            const maxCount = Math.max(...Object.values(tagCounts));
            const size = minSize + ((count / maxCount) * (maxSize - minSize));
            const colorIdx = getColorIndex(tag);
            const color = colorPalette[colorIdx];

            return (
              <a
                href={`/tags/${tag.toLowerCase()}`}
                class={`inline-flex items-center gap-2 px-3 py-1.5 rounded-md
                       ${color.bg} ${color.hover}
                       text-white font-medium
                       hover:scale-105 hover:shadow-md
                       transition-all duration-200`}
                style={`font-size: ${size}rem;`}
                title={`${count} post${count !== 1 ? 's' : ''}`}
              >
                <span>#</span>
                <span>{tag}</span>
                <span class="text-xs font-mono px-1.5 py-0.5 rounded bg-white/20">
                  {count}
                </span>
              </a>
            );
          })
        }
      </div>

      <div class="mt-16 text-center">
        <a
          href="/blog"
          class="inline-flex items-center gap-2 text-blue-600 dark:text-blue-400 hover:underline"
        >
          ← Back to all posts
        </a>
      </div>
    </section>
  </main>
</Layout>
